# Design A Google Analytics like System

## 概要
Google Analyticsのような機能を有するサービスを提供する.

## 必須要件
本サービスを実装するにあたって必須となる要件を以下に示す.

* デイリー数十億件の書き込みイベントが発生する
* 数百万人のユーザが分析に使用するため大量の読み取りが発生する
  * 加えて時系列でデータを表示する
* データ反映の遅延は大きくとも1時間に抑える
* ダウンタイムが小さくなるようにする
* ロジックにバグがあった場合(障害発生時)は実行された箇所まで遡って実行できるようにする

## その他要件

## DB設計
保持するデータのカラムについて考察する.

### 指標について
本サービスはWebページに訪問するユーザの行動を分析するためのサービスである.  
そのため, 本サービスでは分析するための指標を用意する必要がある.  
以下に指標となりうる項目を挙げる(以下はGoogle Analyticsでの指標).

* ユーザに関する指標
  * セッション
  * ユーザ
  * ページビュー数
  * ページ/セッション
  * 平均セッション時間
  * 直帰率
  * 新規セッション率
* 行動に関する指標
  * ページビュー数
  * ページ別訪問回数
  * 平均ページ滞在時間
  * 閲覧開始数
  * 直帰率
  * 離脱率
  * ページの価値
* 目標・コンバージョンに関する指標
  * 目標の完了数
  * 目標値
  * コンバージョン率
  * 目標の放棄率

上記の項目のうちいくつかは別の指標がわかれば導出できるものとなっている(特に割合関係).  
そのため, ベースとなる指標を用意し, それらを取得できるようにする.  
ベースとする指標は以下の通り.

* セッション
* aaaa

### カラム定義
上記の指標を基にカラムを決定する.

## 外部設計
計測ツールがブラウザで発火した時に情報を送信するためのエンドポイントを以下に示す.

## 詳細設計
必須要件として大量のデータの書き込みイベントが発生する. 
また, 加えてリアルタイムにデータ読み取りがなされる.  
このことからデータの処理はストリーム処理で実現するのが好ましいと思われる.  
このストリーム処理を実現するために [`Apache Kafka`](https://kafka.apache.org/) と [`Apache Flink`](https://flink.apache.org/) を用いる.  
各システムを用いるモチベーションは以下の通り.

* `Apache Kafka`
  * 分散メッセージングシステムであり, 大容量のデータを高スループット/低レイテンシで扱うことを目的としている
  * クラスタを構成するため, 耐障害性に優れる
  * シングルクラスタで大量のデータを扱うことができ, なおかつダウンタイムなしで透過的にスケールさせることができる
  * [参考](https://deeeet.com/writing/2015/09/01/apache-kafka/)
* `Apache Flink`
  * 分散ストリーム処理を行うフレームワークの一つであり, 高パフォーマンス, 低レイテンシで処理することができる
  * ステートフルであり, 障害発生時はその状態を元に処理を再開することができるため(Exactly Once)耐障害性に優れる
  * バッチ処理も可能
  * [参考](https://qiita.com/takanorig/items/e9880813798f0ac5679d)
